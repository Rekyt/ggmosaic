---
title: "Mosaic plots with `ggplot2`"
author: "Haley Jeppson and Heike Hofmann"
date: "`r Sys.Date()`"
output:
  rmarkdown::html_vignette:
  toc: true
vignette: >
  %\VignetteIndexEntry{Mosaic plots with `ggplot2`}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---


  ```{r setup, echo=FALSE}

knitr::opts_chunk$set(fig.width = 6,
                      fig.height = 4,
                      fig.align='center',
                      dev = "png")

```

```{r echo=FALSE, message=FALSE}
library(ggmosaic)
data(happy, package="productplots")
data(Titanic)
titanic <- as.data.frame(Titanic)
multiplot <- function(..., plotlist=NULL, file, cols=1, layout=NULL) {
  library(grid)

  # Make a list from the ... arguments and plotlist
  plots <- c(list(...), plotlist)

  numPlots = length(plots)

  # If layout is NULL, then use 'cols' to determine layout
  if (is.null(layout)) {
    # Make the panel
    # ncol: Number of columns of plots
    # nrow: Number of rows needed, calculated from # of cols
    layout <- matrix(seq(1, cols * ceiling(numPlots/cols)),
                     ncol = cols, nrow = ceiling(numPlots/cols))
  }

  if (numPlots==1) {
    print(plots[[1]])

  } else {
    # Set up the page
    grid.newpage()
    pushViewport(viewport(layout = grid.layout(nrow(layout), ncol(layout))))

    # Make each plot, in the correct location
    for (i in 1:numPlots) {
      # Get the i,j matrix positions of the regions that contain this subplot
      matchidx <- as.data.frame(which(layout == i, arr.ind = TRUE))

      print(plots[[i]], vp = viewport(layout.pos.row = matchidx$row,
                                      layout.pos.col = matchidx$col))
    }
  }
}

```

# Introduction

### Basic Explanation of `ggmosaic`  
  
`ggmosiac` produces a mosaic plot as a convenient graphical summary of the conditional distributions in a contingency table. The area of the graphical element is propotional to the underlying probability, so we are easily able to visualize how the joint distribuiton is composed of the product of the conditional and marginal distributions which allows us to see any association that may be occuring between the variables. Because the plot is constructed hierarchically, the ordering of the variables is very important.  

### Types of partitioning

There are two main ways to partition the area - into bars or into spines. When the area is partitioned into bars,the height is proportional to value and the width equally divides the space. Bars can be arranged horizontally (“hbar”) or vertically (“vbar”). Alternatively, the space can be partitioned into spines, where the width is proportional to value, height occupies full range. Spines are space filling and can be arranged horizontally (“hspine”) or vertically (“vspine”).

```{r happy, echo=FALSE, message=FALSE, fig.width = 7, fig.height = 7}
a <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(marital)), divider="hspine")+
   theme(axis.text.x=element_text(angle=35, hjust= 1))+labs(x=" ", title="hspine")

b <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(marital), y= product(marital)), divider="vspine")+
   labs(y=" ", x="", title="vspine")

c <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(marital)), divider="hbar")+
   theme(axis.text.x=element_text(angle=35, hjust= 1))+labs(x=" ", title="hbar")

d <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(marital), y= product(marital)), divider="vbar")+
   labs(y=" ", x="", title="vbar")

multiplot(c, d, a, b, layout=matrix(c(1:4), nrow=2, byrow=FALSE))


# ggplot(data = titanic) +
#   geom_mosaic(aes(weight = Freq,  x = product(Class)))
# ggplot(data = titanic) +
#   geom_mosaic(aes(weight = Freq,  x = product(Class)), divider = "hspine")
# ggplot(data = titanic) +
#   geom_mosaic(aes(weight = Freq,  x = product(Class)), divider = "hbar")
# ggplot(data = titanic) +
#   geom_mosaic(aes(weight = Freq,  x = product(Class)), divider = "vbar")
```


## Hierarchical construction

To demonstrate the capabilities of `ggmosaic` and to emphasize the importance of the ordering of variables, the following example begins with a one-dimensional data set and is gradually built up to a higher-dimensional data set. 

 **Explain the statistical formula** $f(x1, x2, x3) = f(x1 | x2, x3) f(x2, x3) $
 
#### One variable

To begin, to plot is divded into horizontal spines - each representing the proportion of respondents that were a particular level of happy. This plot is useful for answering questions such as, "what proportion of the respondents were very happy?" 

```{r happy-1, echo=FALSE, message=FALSE}
# ggplot(data = titanic) +
#  geom_mosaic(aes(weight = Freq, x = product(Sex)))
ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(happy)), divider=mosaic("h"))+
   theme(axis.text.x=element_text(angle=0, hjust= .5))+labs(x="Happiness", title=" f(happy) ")

```

 
#### Two variables 

This example took the first plot in which the plot was divided into horizontal spines representing the different levels of happiness of the respondents and then split each spine into vertical spines representing the different responses for health. This plot can be used to answer questions such as "what proportion of those not too happy were of excellent health?"


```{r happy-2, echo=FALSE, message=FALSE}
ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(happy), y=product(health), fill=health)) +
   theme(axis.text.x=element_text(angle=0, hjust= .5))+labs(x="Happiness", y="Health",  title=" f(health, happy) = f(health|happy) f(happy) ")

```

  
#### Three variables 
  
This plot can be used to answer questions such as "what proportion of those not too happy and of excellent health are female?"

```{r happy-3, echo=FALSE, message=FALSE}
ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(health, happy), y = product(health), fill=sex)) +
   theme(axis.text.x=element_text(angle=0, hjust= .5))+labs(x="Happiness", y="Health",  title=" f(sex, health, happy) = f(sex|health, happy) f(health, happy) ")
```


### Importance of ordering

The order in which the variables are listed in the formula can have a large effect the graph -- due to the statistical formula...

For example, 

```{r happy-order, echo=FALSE, message=FALSE, fig.width = 8, fig.height = 3.5}
o1 <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(sex), y=product(degree), fill=degree)) +
  theme(axis.text.x=element_text(angle=0, vjust= -.5), plot.title = element_text(size = rel(1))) + 
  labs(x="Sex", y="Degree",  title=" f(degree, sex) = f(degree|sex) f(sex) ")

o2 <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(degree), y=product(sex), fill=sex)) +
  theme(axis.text.x=element_text(angle=0, vjust= -.50), plot.title = element_text(size = rel(1))) + 
  labs(x="Degree", y="Sex",  title=" f(sex, degree) = f(sex|degree) f(degree) ")

multiplot(o1, o2, layout=matrix(c(1:2), nrow=1, byrow=FALSE))

```


### Conditioning

```{r conditioning, echo=FALSE, message=FALSE, fig.width = 8, fig.height = 3.5}

c1 <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(happy), conds= degree, fill = happy) ) +  theme(axis.text.x=element_text(angle=25, hjust= 1))+labs(x="Degree", y="Happiness",  title="  f(happy| degree) ")

c2 <- ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(happy), conds= degree, fill = degree) ) +  theme(axis.text.x=element_text(angle=25, hjust= 1))+labs(x="Degree", y="Happiness",  title="  f(happy| degree) ")

multiplot(c1, c2, layout=matrix(c(1:2), nrow=1, byrow=FALSE))


```

#### Other parameters that can be set:

Facetting, offset, removing of NA's, and thinning of labels example:

```{r happy-a, echo=FALSE, message=FALSE}
#labels <- c(17+1:72, NA)
#labels[labels %% 5 != 0] <- ""

ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(age), fill=marital), na.rm = TRUE, offset=0) +
   theme(axis.text.x=element_text(angle=0, hjust= .5))+labs(x="Age", y=" ",  title=" f(health, age | sex)") + facet_grid(sex~.) 
# + scale_x_product("Age", labels=labels)

```




### Other

Double decker plot

```{r double-decker, echo=FALSE, message=FALSE}

ggplot(data = happy) +
  geom_mosaic(aes(weight = wtssall,  x = product(sex, finrela), fill=happy), na.rm = TRUE, divider = ddecker()) +
   theme(axis.text.x=element_text(angle=25, hjust=1))+labs(x="Sex:Finrela", y=" ",  title=" Double decker plot ")  

```
